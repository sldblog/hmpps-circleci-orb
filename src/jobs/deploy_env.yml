---
description: >
  Deploy via helm, using chart found in the helm_deploy dir of the repo.
  Optionally send a slack notification.
executor: default
parameters:
  env:
    type: string
    default: dev
  release_name:
    type: string
    default: ${CIRCLE_PROJECT_REPONAME}
  chart_name:
    type: string
    default: ${CIRCLE_PROJECT_REPONAME}
  helm_dir:
    type: string
    default: helm_deploy
  helm_values_file:
    type: string
    default: "values-<< parameters.env >>.yaml"
  slack_notification:
    type: boolean
    default: false
  helm_additional_args:
    type: string
    default: ""
  retrieve_secrets:
    type: string
    default: aws
steps:
  - checkout
  - k8s_setup
  - install_helm
  - install_aws_cli
  - mem/recall:
      env_var: APP_VERSION
  - deploy:
      name: Deploy to << parameters.env >>
      working_directory: << parameters.helm_dir >>
      command: |
        sed -i "s/appVersion: \".*\"/appVersion: \"${APP_VERSION}\"/g" << parameters.chart_name >>/Chart.yaml

        if [[ "<< parameters.retrieve_secrets >>" == 'aws' ]]; then
          aws secretsmanager get-secret-value --secret-id ${AWS_SECRET_NAME} | jq -r .SecretString | \
          helm upgrade << parameters.release_name >> << parameters.chart_name >> \
            --install --wait --reset-values --timeout 5m --history-max 10 \
            --values << parameters.helm_values_file >> \
            --values - \
            --set image.tag="${APP_VERSION}" \
            << parameters.helm_additional_args >>
        else
          helm upgrade << parameters.release_name >> << parameters.chart_name >> \
            --install --wait --reset-values --timeout 5m --history-max 10 \
            --values << parameters.helm_values_file >> \
            --set image.tag="${APP_VERSION}" \
            << parameters.helm_additional_args >>
        fi
  - when:
      condition: <<parameters.slack_notification>>
      steps:
        - slack/notify:
            message: "*<< parameters.release_name >>* version:*${APP_VERSION}* deployed to << parameters.env >>"
            include_project_field: false
            include_job_number_field: false
